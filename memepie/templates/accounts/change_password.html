{% extends 'base.html' %}

{% block title %}Change Password â€¢ MemePie{% endblock %}

{% block content %}
<div class="auth-card mx-auto" style="max-width: 480px;">
    <div class="d-flex align-items-center gap-3 mb-4">
        <a href="{% url 'settings' %}" class="text-muted text-decoration-none"><i class="bi bi-arrow-left fs-5"></i></a>
        <div>
            <h5 class="mb-0 fw-bold">Change Password</h5>
            <small class="text-muted">Confirm your identity with your current password</small>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-3 rounded-3" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST" novalidate>
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label fw-semibold">Current Password</label>
            <div class="input-group-password">
                <input type="password" name="old_password" id="old_password" class="form-control rounded-3" placeholder="Enter current password" required>
                <button type="button" class="pwd-toggle" onclick="togglePwd('old_password', this)"><i class="bi bi-eye"></i></button>
            </div>
        </div>

        <hr class="my-3 opacity-25">

        <div class="mb-3">
            <label class="form-label fw-semibold">New Password</label>
            <div class="input-group-password">
                <input type="password" name="new_password1" id="new_password1" class="form-control rounded-3" placeholder="At least 8 characters" required>
                <button type="button" class="pwd-toggle" onclick="togglePwd('new_password1', this)"><i class="bi bi-eye"></i></button>
            </div>
            <!-- Strength Bar -->
            <div class="mt-2">
                <div class="progress" style="height:4px; border-radius:2px;">
                    <div class="progress-bar" id="strength-bar" style="width:0%; transition: width 0.3s, background 0.3s;"></div>
                </div>
                <small id="strength-label" class="text-muted" style="font-size:0.75rem;"></small>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-semibold">Confirm New Password</label>
            <div class="input-group-password">
                <input type="password" name="new_password2" id="new_password2" class="form-control rounded-3" placeholder="Repeat new password" required>
                <button type="button" class="pwd-toggle" onclick="togglePwd('new_password2', this)"><i class="bi bi-eye"></i></button>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">
            <i class="bi bi-shield-check me-2"></i>Update Password
        </button>
    </form>
</div>

<style>
.input-group-password {
    position: relative;
}
.input-group-password .form-control {
    padding-right: 2.8rem;
}
.pwd-toggle {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    z-index: 10;
    font-size: 1rem;
    padding: 0;
}
</style>

<script>
function togglePwd(id, btn) {
    const input = document.getElementById(id);
    const isHidden = input.type === 'password';
    input.type = isHidden ? 'text' : 'password';
    btn.querySelector('i').className = isHidden ? 'bi bi-eye-slash' : 'bi bi-eye';
}

const pwdInput = document.getElementById('new_password1');
const bar = document.getElementById('strength-bar');
const label = document.getElementById('strength-label');

pwdInput.addEventListener('input', () => {
    const val = pwdInput.value;
    let score = 0;
    if (val.length >= 8) score++;
    if (/[A-Z]/.test(val)) score++;
    if (/[0-9]/.test(val)) score++;
    if (/[^A-Za-z0-9]/.test(val)) score++;

    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e'];
    const labels = ['Weak', 'Fair', 'Good', 'Strong'];
    const pct = [25, 50, 75, 100];

    if (val.length === 0) {
        bar.style.width = '0%'; label.textContent = ''; return;
    }
    const idx = Math.min(score - 1, 3);
    bar.style.width = pct[idx] + '%';
    bar.style.background = colors[idx];
    label.textContent = `Password strength: ${labels[idx]}`;
    label.style.color = colors[idx];
});
</script>
{% endblock %}
